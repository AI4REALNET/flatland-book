Observations
===

In Flatland, you have full control over the observations that your agents will work with. Three observations are provided as starting point. However, you are encouraged to implement your own.

The three provided observations are:
- Global observation
- Local grid observation
- Local tree observation

![stock observations](https://i.imgur.com/oo8EIYv.png)

*A visual summary of the three provided observations.*

Global observation
---

The global observation is the simplest one. In this case, every agent is provided a global view of the full flatland environment. This can be compared to the full, raw-pixel data used in Atari games. The size of the observation space is `h × w × c`, where `h` is the height of the environment, `w` is the width of the environment and `c` is the number of channels of the environment. These channels can be modified by the participants but in the initial configuration, we include the following 5 `h × w` channels:

- **Transition maps:** provides a unique value for each type of transition map and its orientation. This gives the agent an overview of the current map.
- **Agent position:** a one-hot representation of the agent’s position in the map.
- **Agent target:** a one-hot representation of the agent’s target in the map.
- **Other agents:** a one-hot representation of all other agents’ positions in the map.
- **Other targets:** a one-hot representation of all the other agents’ targets in the map.

This observation space is well suited for single-agent navigation but does not provide enough information to solve the multi-agent navigation task, thus participants must improve on this observation space to solve the challenge.

Local grid observation
---

The local grid observation is very similar to the global observation, where we only replace $h$ and $w$ by agent specific dimensions. Each agent with index $i$ has an observation grid of uneven width $w_i$ and arbitrary height $h_i$ which is spanned from its current position. The agent is always situated at the position `(0, (width + 1)/2)` within the observation grid, and the observation grid is rotated according to the agent’s direction such that the full height $h_i$ of the observation grid is in front of the agent.

The initial local grid view provides the same channels as the initial global view introduced above. This observation space offers benefits over the global view, mostly by reducing the amount of irrelevant information in the observation space. Global navigation with this local observation would be impossible if no general information about the target location were given (especially when the target is outside of view). We therefore compute a distance map for every agent-target and provide this distance map as an additional channel:

- **Distance map:** This additional channel in the local observation grid allows for a sense of direction without the need of a global view.

<img width="500" src="https://drive.google.com/uc?export=view&id=1kZzinMOs7hlPaSJJeIiaQ7lAz2erXuHx">

*An abstract visualization of the local field of view of an agent. The green boxes represent visible cells in the agents field of view. This field of view is turned as the agent’s direction changes.*

Local tree observation
---

The tree observation exploits the fact that a railway network is a graph and thus the observation is only built along allowed transitions in the graph. The observation is generated by spanning a 4 branched tree from the current position of the agent. Each branch follows the allowed transitions (backward branch only allowed at dead-ends) until a cell with multiple allowed transitions is reached. Here the information gathered along the branch is stored as a node in the tree. Here is a small example of a railway network with an agent in the top left corner. The tree observation is build by following the allowed transitions for that agent.

![Small_Network](https://i.imgur.com/utqMx08.png)

As we move along the allowed transitions we build up a tree where a new node is created at every cell where the agent has different possibilities (Switch), dead-end or the target is reached.
It is important to note that the tree observation is always build according to the orientation of the agent at a given node. This means that each node always has 4 branches coming from it in the directions *Left, Forward, Right and Backward*. These are illustrated with different colors in the figure below. The tree is build form the example rail above. Nodes where there are no possibilities are filled with `-inf` and are not all shown here for simplicity. The tree however, always has the same number of nodes for a given tree depth.

![Tree_Observation](https://i.imgur.com/VsUQOQz.png)

Each node is filled with information gathered along the path to the node. Currently each node contains 9 features:
- 1: if own target lies on the explored branch the current distance from the agent in number of cells is stored.
- 2: if another agents target is detected the distance in number of cells from current agent position is stored.
- 3: if another agent is detected the distance in number of cells from current agent position is stored.
- 4: possible conflict detected (This only works when we use a predictor and will not be important in this tutorial)
- 5: if an not usable switch (for agent) is detected we store the distance. An unusable switch is a switch where the agent does not have any choice of path, but other agents coming from different directions might. 
- 6: This feature stores the distance (in number of cells) to the next node (e.g. switch or target or dead-end)
- 7: minimum remaining travel distance from node to the agent's target given the direction of the agent if this path is chosen
- 8: agent in the same direction found on path to node
    - n = number of agents present same direction (possible future use: number of other agents in the same direction in this branch)
    - 0 = no agent present same direction
- 9: agent in the opposite direction on path to node
    - n = number of agents present other direction than myself
    - 0 = no agent present other direction than myself